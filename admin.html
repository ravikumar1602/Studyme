<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Study Portal</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --warning-color: #f6c23e;
            --light-bg: #f8f9fc;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, var(--primary-color) 0%, #224abe 100%);
            color: white;
            padding: 0;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            margin: 0.2rem 0.5rem;
            border-radius: 0.35rem;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            padding: 1rem 1.35rem;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            padding: 0.75rem 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        /* Loading spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Admin Container -->
    <div class="container-fluid p-0 min-vh-100">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-lg-2 sidebar d-none d-lg-block">
                <div class="d-flex flex-column h-100">
                    <div class="py-4 px-3 text-center">
                        <h4 class="mb-0">Study Portal</h4>
                        <small class="text-white-50">Admin Panel</small>
                    </div>
                    <hr class="my-0 bg-white-50">
                    <div class="nav flex-column mt-3">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-fw fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="#" class="nav-link" data-section="videos">
                            <i class="fas fa-fw fa-video"></i>
                            <span>Manage Videos</span>
                        </a>
                        <a href="#" class="nav-link" data-section="subjects">
                            <i class="fas fa-fw fa-book"></i>
                            <span>Subjects</span>
                        </a>
                        <a href="#" class="nav-link" data-section="users">
                            <i class="fas fa-fw fa-users"></i>
                            <span>Users</span>
                        </a>
                    </div>
                    <div class="mt-auto p-3 text-center">
                        <button id="logoutBtn" class="btn btn-sm btn-outline-light w-100">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 ms-auto">
                <!-- Top Navigation -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid px-4">
                        <button class="btn btn-link d-lg-none" id="sidebarToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="d-flex align-items-center ms-auto">
                            <span class="me-3 d-none d-sm-inline" id="userEmail">user@example.com</span>
                            <div class="dropdown">
                                <button class="btn btn-link text-dark dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user-circle fa-2x"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" id="logoutLink"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Page Content -->
                <main class="main-content" id="mainContent">
                    <!-- Video Management Section -->
                    <div id="videosSection" class="section-content">
                        <div class="container-fluid py-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2 class="mb-0">Manage Videos</h2>
                                <button id="addVideoBtn" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Add New Video
                                </button>
                            </div>

                            <!-- Search and Filter -->
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" id="searchVideos" class="form-control" placeholder="Search videos...">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <select id="filterSubject" class="form-select">
                                        <option value="">All Subjects</option>
                                        <option value="history">History</option>
                                        <option value="geography">Geography</option>
                                        <option value="mathematics">Mathematics</option>
                                        <option value="science">Science</option>
                                        <option value="english">English</option>
                                        <option value="gk">General Knowledge</option>
                                        <option value="reasoning">Reasoning</option>
                                        <option value="polity">Polity</option>
                                        <option value="economics">Economics</option>
                                        <option value="environment">Environment</option>
                                        <option value="current-affairs">Current Affairs</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Videos Table -->
                            <div class="card">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Thumbnail</th>
                                                    <th>Title</th>
                                                    <th>Subject</th>
                                                    <th>Date Added</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="videosList">
                                                <!-- Videos will be loaded here dynamically -->
                                                <tr>
                                                    <td colspan="5" class="text-center py-5">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 mb-0">Loading videos...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Video Form Modal -->
                    <div class="modal fade" id="videoFormModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="videoModalLabel">Add New Video</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form id="videoForm">
                                    <div class="modal-body">
                                        <input type="hidden" id="videoId">
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6 mb-3 mb-md-0">
                                                <label for="videoTitle" class="form-label">Video Title *</label>
                                                <input type="text" class="form-control" id="videoTitle" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="videoSubject" class="form-label">Subject *</label>
                                                <select class="form-select" id="videoSubject" required>
                                                    <option value="">Select Subject</option>
                                                    <option value="history">History</option>
                                                    <option value="geography">Geography</option>
                                                    <option value="mathematics">Mathematics</option>
                                                    <option value="science">Science</option>
                                                    <option value="english">English</option>
                                                    <option value="gk">General Knowledge</option>
                                                    <option value="reasoning">Reasoning</option>
                                                    <option value="polity">Polity</option>
                                                    <option value="economics">Economics</option>
                                                    <option value="environment">Environment</option>
                                                    <option value="current-affairs">Current Affairs</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="videoTeacher" class="form-label">Teacher *</label>
                                                <select class="form-select" id="videoTeacher" required>
                                                    <option value="">Select Teacher</option>
                                                    <option value="khan">Khan Sir</option>
                                                    <option value="sarah">Sarah Johnson</option>
                                                    <option value="david">David Miller</option>
                                                    <option value="priya">Priya Sharma</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label for="videoDescription" class="form-label mb-0">Description</label>
                                                <button type="button" id="generateDescriptionBtn" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-magic me-1"></i> Generate with AI
                                                </button>
                                            </div>
                                            <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                                            <div class="form-text">Click "Generate with AI" to create a description based on the video title</div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6 mb-3 mb-md-0">
                                                <label for="videoUrl" class="form-label">YouTube Video URL *</label>
                                                <input type="url" class="form-control" id="videoUrl" required>
                                                <div class="form-text">Paste the full YouTube URL (e.g., https://www.youtube.com/watch?v=...)</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="videoThumbnail" class="form-label">Thumbnail URL</label>
                                                <input type="url" class="form-control" id="videoThumbnail">
                                                <div class="form-text">Leave empty to use YouTube thumbnail</div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="videoTags" class="form-label">Tags (comma separated)</label>
                                            <input type="text" class="form-control" id="videoTags">
                                            <div class="form-text">Add relevant tags to help with search (e.g., class-10, cbse, important)</div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary" id="saveVideoBtn">
                                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                            Save Video
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Confirmation Modal -->
                    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm Delete</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete this video? This action cannot be undone.</p>
                                    <p class="fw-bold mb-0">Video: <span id="videoToDeleteTitle"></span></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        Delete Video
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div> 
                                       placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                            <div class="form-group">
                                <label for="video-title">Title</label>
                                <input type="text" id="video-title" name="title" required 
                                       placeholder="Enter video title">
                            </div>
                            <div class="form-group">
                                <label for="video-description">Description</label>
                                <textarea id="video-description" name="description" 
                                          placeholder="Enter video description (optional)"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="video-thumbnail">Thumbnail URL (optional)</label>
                                <input type="url" id="video-thumbnail" name="thumbnail" 
                                       placeholder="https://example.com/thumbnail.jpg">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="cancel-video-btn" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Video</button>
                            </div>
                        </form>
                    </div>

                    <div class="video-list">
                        <div class="filters">
                            <div class="search-bar">
                                <input type="text" id="search-videos" placeholder="Search videos...">
                            </div>
                            <div class="filter-group">
                                <label for="filter-subject">Filter by Subject:</label>
                                <select id="filter-subject">
                                    <option value="">All Subjects</option>
                                    <option value="history">History</option>
                                    <option value="geography">Geography</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="science">Science</option>
                                    <option value="english">English</option>
                                    <option value="gk">General Knowledge</option>
                                    <option value="reasoning">Reasoning</option>
                                    <option value="polity">Polity</option>
                                    <option value="economics">Economics</option>
                                    <option value="environment">Environment</option>
                                    <option value="current-affairs">Current Affairs</option>
                                <option value="history">History</option>
                                <option value="geography">Geography</option>
                                <option value="mathematics">Mathematics</option>
                                <option value="science">Science</option>
                                <option value="english">English</option>
                                <option value="gk">General Knowledge</option>
                                <option value="reasoning">Reasoning</option>
                            </select>
                            <select id="filter-teacher">
                                <option value="">All Teachers</option>
                                <option value="khan">Khan Sir</option>
                                <option value="sarah">Sarah Johnson</option>
                                <option value="david">David Miller</option>
                                <option value="priya">Priya Sharma</option>
                            </select>
                        </div>
                        <div id="videos-list">
                            <!-- Videos will be loaded here -->
                            <div class="loading">Loading videos...</div>
                        </div>
                    </div>
                </div>

                <div id="subjects-section" class="content-section">
                    <h2>Manage Subjects</h2>
                    <p>Subject management coming soon...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            where 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Import the admin module
        import { initAdmin } from './js/admin-new-clean.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7tdxFyTOWOqaAxJptAq5vZm92oz1v05M",
            authDomain: "study-portal-bef7a.firebaseapp.com",
            projectId: "study-portal-bef7a",
            storageBucket: "study-portal-bef7a.firebasestorage.app",
            messagingSenderId: "335677529543",
            appId: "1:335677529543:web:0e95959d30b3b3daf4cde2",
            measurementId: "G-DPBGHHW8ZF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make auth and db available globally
        window.auth = auth;
        window.db = db;

        // DOM Elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const mainContent = document.getElementById('mainContent');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutLink = document.getElementById('logoutLink');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const navLinks = document.querySelectorAll('.sidebar .nav-link');

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // User is not signed in, redirect to login
                window.location.href = 'login.html';
            } else {
                // User is signed in
                console.log('User is signed in:', user.email);
                document.getElementById('userEmail').textContent = user.email;
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                // Initialize admin module with Firebase instances
                initAdmin({ auth, db });
            }
        });

        // Handle logout
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error signing out. Please try again.', 'error');
            }
        }

        // Load admin module
        async function loadAdminModule() {
            try {
                // Import and initialize admin module
                const { initAdmin } = await import('./js/admin-new-clean.js');
                if (typeof initAdmin === 'function') {
                    await initAdmin();
                } else {
                    throw new Error('Admin module initialization function not found');
                }
            } catch (error) {
                console.error('Error loading admin module:', error);
                showNotification('Error initializing admin interface. Please refresh the page.', 'error');
                
                // Show error message in the UI
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="alert alert-danger m-4">
                            <h4 class="alert-heading">Error Loading Admin Panel</h4>
                            <p>There was an error initializing the admin interface. Please try refreshing the page.</p>
                            <hr>
                            <p class="mb-0">${error.message || 'If the problem persists, please contact support.'}</p>
                            <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Page
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'success') {
            // Remove any existing notifications
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Create notification element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.role = 'alert';
            alertDiv.style.zIndex = '9999';
            
            // Add appropriate icon based on message type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error' || type === 'danger') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${icon} me-2"></i>
                    <div>${message}</div>
                    <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }
            }, 5000);
        }

        // Event Listeners
        if (logoutBtn) {
            logoutBtn.addEventListener('click', handleLogout);
        }
        
        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
        }

        // Mobile sidebar toggle
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('d-none');
            });
        }

        // Close sidebar when clicking on a nav link (mobile)
        if (navLinks.length > 0 && sidebar) {
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 992) {
                        sidebar.classList.add('d-none');
                    }
                });
            });
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 992 && sidebar) {
                sidebar.classList.remove('d-none');
            }
        });

        // Show loading state initially
        if (loadingSpinner) {
            loadingSpinner.style.display = 'flex';
        }
    </script>
</body>
</html>
